# 2FAè®¾ç½®é”™è¯¯ä¿®å¤ææ¡ˆ

## ææ¡ˆä¿¡æ¯
- **åˆ›å»ºæ—¥æœŸ**: 2026-01-25
- **åˆ›å»ºäºº**: Sisyphus
- **çŠ¶æ€**: å¾…å®æ–½
- **ä¼˜å…ˆçº§**: ç´§æ€¥
- **æ ‡ç­¾**: bug, 2fa, deployment, infrastructure

## é—®é¢˜æè¿°

### ç°è±¡ç—‡çŠ¶
ç”¨æˆ·ç™»å½•åç‚¹å‡»"å¼€å¯2FA"ï¼Œé¡µé¢æŠ¥é”™ï¼š
- **é”™è¯¯ä¿¡æ¯**: `405 Method Not Allowed` on POST to `/api/auth/2fa/setup`
- **è®¿é—®åŸŸå**: `www.moneradigital.com`
- **APIé”™è¯¯**: `[Pasted ~15 linesFailed to load resource: the server responded with a status of 401 ()`
- **JSONè§£æé”™è¯¯**: `SyntaxError: Unexpected end of JSON input`
- **åç«¯æŒ‡å‘**: `monera-digital--gyc567.replit.app`

### æ ¹æœ¬åŸå› åˆ†æ

ç»è¿‡ç³»ç»Ÿæ€§åˆ†æï¼Œç¡®è®¤äº†**åŒé‡æ ¹æœ¬åŸå› **ï¼š

#### ğŸ¯ ä¸»è¦åŸå› ï¼šVercelç¯å¢ƒå˜é‡é…ç½®é”™è¯¯
**é—®é¢˜**: `VITE_API_BASE_URL` ç¯å¢ƒå˜é‡ä»è®¾ç½®ä¸ºæ—§çš„Replitåç«¯URL
```bash
å½“å‰å€¼: monera-digital--gyc567.replit.app
æœŸæœ›å€¼: https://www.moneradigital.com (æˆ–æ–°ç”Ÿäº§URL)
```

**å½±å“**: 
- å‰ç«¯è¯·æ±‚è¢«è·¯ç”±åˆ°å·²å…³é—­çš„Replitåç«¯
- å¯¼è‡´401è®¤è¯é”™è¯¯å’ŒJSONè§£æå¤±è´¥

#### ğŸ”§ æ¬¡è¦åŸå› ï¼švercel.jsoné…ç½®ä¸å®Œæ•´
**é—®é¢˜**: ç¼ºå°‘2FAç›¸å…³çš„APIè·¯ç”±é‡å†™è§„åˆ™
**å½“å‰çŠ¶æ€**: vercel.jsonåªæœ‰é€šé…ç¬¦é‡å†™ `/(.*)` â†’ `/index.html`
**éœ€è¦**: ä¸º2FAç«¯ç‚¹æ·»åŠ ç‰¹å®šé‡å†™è§„åˆ™

## è§£å†³æ–¹æ¡ˆ

### é˜¶æ®µ1: Vercelç¯å¢ƒå˜é‡ä¿®å¤ (æ ¹æœ¬è§£å†³)

#### æ­¥éª¤1: æ›´æ–°VITE_API_BASE_URL
```bash
# åœ¨Vercel Dashboardä¸­æˆ–ä½¿ç”¨CLIæ›´æ–°ç¯å¢ƒå˜é‡
VITE_API_BASE_URL=https://www.moneradigital.com
```

#### æ­¥éª¤2: éªŒè¯ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ
```bash
# ç­‰å¾…Vercelé‡æ–°éƒ¨ç½²åéªŒè¯
vercel env ls  # ç¡®è®¤æ–°å€¼å·²ç”Ÿæ•ˆ
```

### é˜¶æ®µ2: vercel.jsonè·¯ç”±é…ç½®ä¼˜åŒ–

#### æ­¥éª¤3: æ·»åŠ 2FAç‰¹å®šé‡å†™è§„åˆ™
```json
{
  "rewrites": [
    {
      "source": "/api/auth/2fa/setup",
      "destination": "https://www.moneradigital.com/api/auth/2fa/setup"
    },
    {
      "source": "/api/auth/2fa/enable", 
      "destination": "https://www.moneradigital.com/api/auth/2fa/enable"
    },
    {
      "source": "/api/auth/2fa/disable",
      "destination": "https://www.moneradigital.com/api/auth/2fa/disable"
    },
    {
      "source": "/api/auth/2fa/verify-login",
      "destination": "https://www.moneradigital.com/api/auth/2fa/verify-login"
    },
    {
      "source": "/api/auth/2fa/verify",
      "destination": "https://www.moneradigital.com/api/auth/2fa/verify"
    },
    // ä¿ç•™ç°æœ‰é‡å†™è§„åˆ™...
    {
      "source": "/api/(core|lending|addresses|withdrawals|deposits|accounts|webhooks|wallet|health|redemption)(.*)",
      "destination": "https://monera-digital--gyc567.replit.app/api/$1$2"
    },
    {
      "source": "/api/auth/:path*",
      "destination": "/api/v2-auth/:path*"
    },
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ]
}
```

### é˜¶æ®µ3: æµ‹è¯•éªŒè¯è®¡åˆ’

#### æµ‹è¯•ç”¨ä¾‹1: ç¯å¢ƒå˜é‡ç”Ÿæ•ˆéªŒè¯
```bash
# 1. éƒ¨ç½²å®Œæˆåæµ‹è¯•
curl -I https://www.moneradigital.com/api/auth/2fa/setup

# æœŸæœ›ç»“æœ: ä¸åº”è¯¥è¿”å›401æˆ–405
# æˆåŠŸæ ‡å‡†: 200 OK æˆ–æ­£ç¡®çš„è®¤è¯é”™è¯¯(401éœ€è¦token)
```

#### æµ‹è¯•ç”¨ä¾‹2: å®Œæ•´2FAæµç¨‹æµ‹è¯•
```bash
# 1. ç™»å½•ç”¨æˆ·è·å–token
# 2. ä½¿ç”¨tokenè°ƒç”¨2FA setup
# 3. éªŒè¯QRç ç”Ÿæˆå’Œè¿”å›æ•°æ®æ ¼å¼
# 4. å¯ç”¨2FAåŠŸèƒ½
```

#### æµ‹è¯•ç”¨ä¾‹3: é”™è¯¯å¤„ç†éªŒè¯
```bash
# 1. æµ‹è¯•æ— tokenè®¿é—® - åº”è¿”å›401
# 2. æµ‹è¯•æ— æ•ˆtokenè®¿é—® - åº”è¿”å›401
# 3. æµ‹è¯•é”™è¯¯å¤„ç†é€»è¾‘
```

## æŠ€æœ¯é£é™©è¯„ä¼°

### ğŸ”´ é«˜é£é™©: ç”Ÿäº§ç¯å¢ƒæœåŠ¡ä¸­æ–­
- **å½±å“èŒƒå›´**: 2FAåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨
- **ç”¨æˆ·å½±å“**: ç”¨æˆ·æ— æ³•å¯ç”¨å®‰å…¨ç™»å½•åŠŸèƒ½
- **ä¸šåŠ¡é£é™©**: å®‰å…¨æ€§é™çº§

### ğŸŸ¡ ä¸­é£é™©: é…ç½®å¤æ‚æ€§
- **æŠ€æœ¯å€ºåŠ¡**: ç¯å¢ƒå˜é‡ä¸åŸŸåä¸åŒ¹é…
- **ç»´æŠ¤æˆæœ¬**: éœ€è¦æ‰‹åŠ¨åè°ƒå¤šä¸ªé…ç½®

### ğŸŸ¢ ä½é£é™©: éƒ¨ç½²å¤±è´¥
- **å›é€€æ–¹æ¡ˆ**: å¿«é€Ÿå›é€€åˆ°å½“å‰vercel.jsoné…ç½®
- **æ•°æ®å®‰å…¨**: ä¸ä¼šå½±å“ç°æœ‰æ•°æ®

## å®æ–½è®¡åˆ’

### å‡†å¤‡å·¥ä½œ
1. [ ] å¤‡ä»½å½“å‰vercel.jsoné…ç½®
2. [ ] ç¡®è®¤Goåç«¯2FAæ¥å£åœ¨æ–°åŸŸåä¸‹å¯ç”¨
3. [ ] æµ‹è¯•å½“å‰é”™è¯¯å¤ç°æ­¥éª¤

### ä¿®å¤å®æ–½
1. [ ] æ›´æ–°Vercelç¯å¢ƒå˜é‡ VITE_API_BASE_URL
2. [ ] æ›´æ–°vercel.jsonæ·»åŠ 2FAé‡å†™è§„åˆ™
3. [ ] æäº¤ä¿®æ”¹åˆ°git
4. [ ] é‡æ–°éƒ¨ç½²åˆ°Vercel

### éªŒè¯æµ‹è¯•
1. [ ] éªŒè¯ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ
2. [ ] æµ‹è¯•2FAè®¾ç½®æ¥å£
3. [ ] æµ‹è¯•å®Œæ•´2FAæµç¨‹
4. [ ] éªŒè¯é”™è¯¯å¤„ç†é€»è¾‘

## éªŒæ”¶æ ‡å‡†

1. âœ… ç¯å¢ƒå˜é‡ VITE_API_BASE_URL æ­£ç¡®æŒ‡å‘ç”Ÿäº§åŸŸå
2. âœ… vercel.jsonåŒ…å«å®Œæ•´çš„2FAè·¯ç”±é‡å†™è§„åˆ™
3. âœ… 2FA setupæ¥å£è¿”å›æ­£ç¡®çš„HTTPçŠ¶æ€ç 
4. âœ… JSONå“åº”æ ¼å¼æ­£ç¡®ï¼Œæ— è§£æé”™è¯¯
5. âœ… å®Œæ•´çš„2FAå¯ç”¨/ç¦ç”¨æµç¨‹æ­£å¸¸å·¥ä½œ
6. âœ… ç”¨æˆ·å¯ä»¥æˆåŠŸæ‰«æQRç å¹¶å¯ç”¨2FA
7. âœ… é”™è¯¯å¤„ç†é€»è¾‘å·¥ä½œæ­£å¸¸

## ç›¸å…³æ–‡æ¡£

- [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md) - éœ€è¦æ›´æ–°ç¯å¢ƒå˜é‡éƒ¨åˆ†
- [APIæ–‡æ¡£](./docs/openapi.yaml) - éªŒè¯2FAç«¯ç‚¹å®šä¹‰
- [é”™è¯¯å¤„ç†æ–‡æ¡£](./docs/audit/2fa-handler-audit.md) - å‚è€ƒ2FAé”™è¯¯å¤„ç†æ¨¡å¼

## å®¡æ‰¹çŠ¶æ€

- [x] é—®é¢˜æ ¹å› ç¡®è®¤ (ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯)
- [x] è§£å†³æ–¹æ¡ˆè®¾è®¡å®Œæˆ
- [ ] ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ
- [ ] vercel.jsoné…ç½®æ›´æ–°å®Œæˆ
- [ ] æµ‹è¯•éªŒè¯é€šè¿‡
- [ ] ç”Ÿäº§éƒ¨ç½²å®Œæˆ
- [ ] ç”¨æˆ·éªŒæ”¶ç¡®è®¤

---

**å¤‡æ³¨**: è¿™æ˜¯å…³é”®çš„åŸºç¡€è®¾æ–½bugï¼Œéœ€è¦ç«‹å³ä¿®å¤ä»¥ç¡®ä¿2FAåŠŸèƒ½çš„æ­£å¸¸å·¥ä½œã€‚ä¿®å¤åéœ€è¦æ›´æ–°DEPLOYMENT_GUIDE.mdæ–‡æ¡£ä»¥é˜²æ­¢ç±»ä¼¼é—®é¢˜ã€‚