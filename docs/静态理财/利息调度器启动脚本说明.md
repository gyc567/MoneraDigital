# Monera Digital 利息调度器启动脚本说明

**文档版本**: v1.0  
**创建日期**: 2026-02-06  
**最后更新**: 2026-02-06

---

## 一、概述

利息调度器是 Monera Digital 定期理财系统的核心后台服务，负责每日自动执行以下任务：

1. **计算每日利息** - 根据用户持有的理财产品计算当日应计利息
2. **结算到期订单** - 自动处理到期赎回或自动续期

---

## 二、文件说明

### 2.1 核心文件

| 文件路径 | 说明 |
|---------|------|
| `cmd/scheduler/main.go` | 独立调度器 Go 入口文件 |
| `scheduler.sh` | Bash 管理脚本 |
| `internal/scheduler/interest.go` | 调度器核心实现 |

### 2.2 scheduler.sh 功能

| 命令 | 功能 |
|-----|------|
| `./scheduler.sh start` | 后台启动服务 |
| `./scheduler.sh stop` | 停止服务 |
| `./scheduler.sh status` | 查看运行状态 |
| `./scheduler.sh log` | 实时查看日志 |
| `./scheduler.sh test` | 前台测试运行一次 |
| `./scheduler.sh help` | 显示帮助信息 |

---

## 三、安装与配置

### 3.1 环境要求

- Go 1.21+
- PostgreSQL 数据库
- 访问权限 (读取 `wealth_order`, `wealth_product`, `account`, `account_journal` 表)

### 3.2 环境变量

| 变量名 | 必需 | 默认值 | 说明 |
|--------|------|--------|------|
| `DATABASE_URL` | ✅ | - | PostgreSQL 连接字符串 |
| `ENV` | - | `development` | 运行环境 |
| `LOG_LEVEL` | - | `info` | 日志级别 |

### 3.3 DATABASE_URL 格式

```
postgresql://[用户名]:[密码]@[主机]:[端口]/[数据库名]?[参数]
```

**示例**:
```bash
# 本地开发
DATABASE_URL="postgresql://user:password@localhost:5432/monera"

# Neon 云数据库
DATABASE_URL="postgresql://user:pass@ep-xxx.us-east-1.aws.neon.tech/neondb?sslmode=require"
```

---

## 四、使用方法

### 4.1 开发环境 - 测试运行

```bash
# 设置环境变量
export DATABASE_URL="postgresql://user:pass@localhost:5432/monera"
export ENV=development

# 前台运行测试 (Ctrl+C 停止)
./scheduler.sh test
```

**输出示例**:
```
==============================================
   Monera Digital 利息调度器 - 独立启动脚本     
==============================================
[INFO] 2026-02-06 21:00:00 - Database connected successfully
[INFO] 2026-02-06 21:00:00 - Interest scheduler initialized
[INFO] 2026-02-06 21:00:00 - First run scheduled
[INFO] 2026-02-06 21:00:00 - Scheduler started
...
```

### 4.2 生产环境 - 后台服务

```bash
# 设置环境变量
export DATABASE_URL="postgresql://..."
export ENV=production
export LOG_LEVEL=info

# 后台启动
./scheduler.sh start

# 查看状态
./scheduler.sh status

# 查看日志
./scheduler.sh log
```

### 4.3 一键启动命令

```bash
DATABASE_URL="postgresql://..." ./scheduler.sh start
```

---

## 五、Crontab 定时任务配置

### 5.1 推荐配置

建议使用 `systemd` 或进程管理工具管理长期运行的服务。

### 5.2 Systemd 服务配置 (Linux)

创建 `/etc/systemd/system/monera-scheduler.service`:

```ini
[Unit]
Description=Monera Digital Interest Scheduler
After=network.target postgresql.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/monera-digital
Environment=DATABASE_URL="postgresql://..."
Environment=ENV=production
ExecStart=/opt/monera-digital/scheduler.sh start
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**启用并启动**:
```bash
sudo systemctl daemon-reload
sudo systemctl enable monera-scheduler
sudo systemctl start monera-scheduler

# 查看状态
sudo systemctl status monera-scheduler

# 查看日志
sudo journalctl -u monera-scheduler -f
```

### 5.3 查看日志

```bash
# Systemd 日志
sudo journalctl -u monera-scheduler -f

# 或查看文件日志
tail -f /var/log/monera-scheduler.log
```

---

## 六、调度器工作流程

### 6.1 执行时间

| 任务 | 时间 | 说明 |
|------|------|------|
| 每日利息计算 | UTC 00:00:05 | 计算前一天的利息 |
| 到期订单结算 | UTC 00:00:05 | 自动处理到期订单 |

### 6.2 每日任务流程

```
┌─────────────────────────────────────────────────────────────┐
│                  UTC 00:00:05                            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 1: 计算每日利息                                     │
│                                                         │
│  FOR each active_order:                                  │
│    IF days_since_start >= 1 AND days_since_start < duration│
│      interest = amount × (apy/100) / 365 × days_held     │
│      UPDATE order.interest_accrued                        │
│                                                         │
│  输出: orders_processed, total_interest                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 2: 结算到期订单                                     │
│                                                         │
│  FOR each expired_order (end_date <= today):              │
│    IF auto_renew = true:                                 │
│      - Pay accrued interest                               │
│      - Create new order (next cycle)                     │
│      - Update old order status → 2 (已续期)             │
│    ELSE:                                                 │
│      - Unfreeze principal                                │
│      - Pay accrued interest                             │
│      - Update order status → 3 (已结算)                  │
│                                                         │
│  输出: orders_settled                                    │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 利息计算公式

```
每日利息 = 本金 × (APY ÷ 100) ÷ 365 × 持有天数

示例:
  - 本金: 10,000 USDT
  - APY: 8.00%
  - 持有: 15天

计算:
  每日 = 10,000 × 0.08 ÷ 365 = 2.1918 USDT
  累计 = 2.1918 × 15 = 32.88 USDT
```

---

## 七、订单状态说明

| 状态 | 值 | 说明 | 触发条件 |
|------|-----|------|---------|
| 生效中 | 1 | 资金冻结，正常计息中 | 申购确认 |
| 已续期 | 2 | 自动续期完成 | 调度器自动续期 |
| 已结算 | 3 | 到期赎回完成 | 到期手动赎回 |
| 已赎回 | 4 | 提前赎回 | 用户主动提前赎回 |

---

## 八、数据库表权限

调度器需要以下数据库表的读写权限：

| 表名 | 操作 | 说明 |
|-----|------|------|
| `wealth_order` | SELECT, UPDATE | 查询订单，计算利息 |
| `wealth_product` | SELECT | 获取产品信息 |
| `account` | UPDATE | 冻结/解冻余额 |
| `account_journal` | INSERT | 记录流水 |

---

## 九、故障排查

### 9.1 常见问题

#### 问题 1: DATABASE_URL 未设置

```
ERROR: DATABASE_URL environment variable is required
解决: export DATABASE_URL="..."
```

#### 问题 2: 数据库连接失败

```
ERROR: Failed to connect to database
解决: 检查数据库地址、用户名、密码、网络连接
```

#### 问题 3: 权限不足

```
ERROR: permission denied for table ...
解决: 授权用户访问所需表
```

### 9.2 查看详细日志

```bash
# 实时日志
./scheduler.sh log

# 查看所有日志
cat /var/log/monera-scheduler.log

# 搜索错误
grep "ERROR" /var/log/monera-scheduler.log
```

### 9.3 日志级别

| 级别 | 说明 |
|------|------|
| `debug` | 详细调试信息 |
| `info` | 一般信息 (默认) |
| `warn` | 警告信息 |
| `error` | 错误信息 |

**设置日志级别**:
```bash
LOG_LEVEL=debug ./scheduler.sh start
```

---

## 十、监控与告警

### 10.1 建议监控指标

| 指标 | 阈值 | 告警方式 |
|------|------|---------|
| 服务进程 | 停止 | 邮件/短信 |
| 日志 ERROR 数量 | > 0 | 邮件 |
| 处理订单数 | 异常波动 | 邮件 |
| 计算利息总额 | 异常波动 | 邮件 |

### 10.2 健康检查

可以通过日志中的关键词监控服务状态：

```bash
# 检查今日任务完成
grep "Daily task completed" /var/log/monera-scheduler.log

# 检查是否有错误
grep "ERROR" /var/log/monera-scheduler.log
```

---

## 十一、相关文档

| 文档 | 路径 |
|------|------|
| 定期理财测试报告 | `/home/yu/webStormProjects/定期理财测试报告.md` |
| 产品需求文档 | `docs/静态理财/` |
| API 文档 | `api/` |

---

## 十二、版本历史

| 版本 | 日期 | 修改内容 |
|------|------|---------|
| v1.0 | 2026-02-06 | 初始版本 |

---

**技术支持**: 如有问题，请查看日志或联系开发团队
