# 🔒 Monera Digital - 前端安全审计报告

**日期**: 2026-01-23
**范围**: 前端代码库 (`/src` 目录)
**方法**: 并行代码分析 + 静态分析 + 依赖审计

---

## 📊 执行摘要

| 严重程度 | 数量 | 状态 |
|----------|------|------|
| 🔴 严重 | 5 | 需要立即处理 |
| 🟠 高 | 6 | 高优先级 |
| 🟡 中 | 7 | 中等优先级 |
| 🟢 低 | 2 | 最好处理 |

**总体风险等级**: **高风险** - 认证和依赖存在严重漏洞

---

## 🔴 严重问题

### 1. JWT 令牌存储在 `localStorage` 中 (CWE-79, CWE-532)

**受影响文件**: `Login.tsx`, `DashboardLayout.tsx`, `Withdraw.tsx`, `Deposit.tsx`, `Lending.tsx`, `AccountOpening.tsx`, `Addresses.tsx`, `Security.tsx`, `Header.tsx`

**问题**:
```typescript
// 严重: 令牌可被页面上的任何 JavaScript 访问
localStorage.setItem("token", data.token);
localStorage.setItem("user", JSON.stringify(data.user));

// 在整个应用程序中检索
const token = localStorage.getItem("token");
```

**风险**:
- XSS 漏洞会将 JWT 令牌暴露给攻击者
- 任何第三方脚本（分析工具、广告、受感染的 CDN）都可访问令牌
- 没有 SameSite 保护
- 令牌无限期持久化（直到手动清除）

**影响**: 通过 XSS 导致账户完全泄露 → 令牌被盗 → 未授权访问

**建议**:
```typescript
// 后端: 使用带有 Secure、SameSite=Strict 的 httpOnly cookie
// 前端: 移除 localStorage, 依赖基于 cookie 的认证
```

---

### 2. 没有令牌刷新机制 (CWE-613)

**受影响文件**: 所有仪表板页面

**问题**:
- JWT 在 24 小时后过期 (`expiresIn: '24h'`)
- 没有实现刷新令牌
- 没有客户端过期检查
- 令牌过期后用户必须重新登录

**风险**:
- 用户体验差
- 令牌过期期间可能出现竞态条件
- 没有静默重新认证

**建议**: 实现刷新令牌流程：短期的访问令牌（15 分钟）+ 长期的刷新令牌（7-30 天）

---

### 3. 依赖漏洞 (7 个高危, 7 个中危)

**包审计结果**:
```bash
npm audit
# 发现 15 个漏洞
# - 7 个高危
# - 7 个中危
# - 1 个低危
```

**严重漏洞**:

| 包 | 严重程度 | CVE | 漏洞 |
|---------|----------|-----|---------------|
| `@remix-run/router` | 高危 | GHSA-2w69-qvjg-hvjx | 开放重定向 XSS |
| `glob` | 高危 | GHSA-5j98-mcp5-4vw2 | 命令注入 |
| `path-to-regexp` | 高危 | GHSA-9wv6-86v2-598j | 正则表达式 DoS |
| `tar` | 高危 | GHSA-8qq5-rm4j-mr97 | 任意文件覆盖 |
| `lodash` | 中危 | GHSA-xxjr-mmjv-4gpg | 原型污染 |

**影响**: 远程代码执行、XSS、DoS 攻击

**建议**:
```bash
npm audit fix
npm audit fix --force  # 对于关键 CVE
```

---

### 4. 关键表单没有客户端输入验证 (CWE-20)

**受影响文件**:
- `src/pages/dashboard/Addresses.tsx` - 地址管理
- `src/pages/dashboard/Lending.tsx` - 借贷申请

**问题**:
```typescript
// Addresses.tsx - 没有验证
const [address, setAddress] = useState("");
const [label, setLabel] = useState("");

// Lending.tsx - 没有验证
const [amount, setAmount] = useState("");
```

**风险**:
- 无效数据发送到后端
- 如果后端未正确验证，可能导致后端漏洞
- 用户体验差

**建议**: 为所有表单实现 Zod 架构:
```typescript
import { z } from 'zod';

const addressSchema = z.object({
  address: z.string().min(1).max(255),
  label: z.string().min(1).max(50),
});

const validated = addressSchema.parse({ address, label });
```

---

### 5. 控制台日志中的敏感数据 (CWE-532)

**受影响文件**: 11 个文件中的 36 条 console 语句

**问题**:
```typescript
// Security.tsx:102 - 记录 2FA 令牌
console.log("Attempting to enable 2FA with token:", token);

// Register.tsx:60 - 记录邮箱
console.log("Attempting registration for:", email);

// 多个文件 - 记录完整的错误对象和堆栈跟踪
console.error("Login error:", error);
```

**风险**:
- 敏感数据暴露在浏览器控制台中
- 堆栈跟踪泄露实现细节
- 生产日志可被攻击者访问

**建议**:
```typescript
// 从生产代码中移除所有 console.log/console.error
// 使用适当的日志服务（已有 pino logger）
```

---

## 🟠 高优先级问题

### 6. 没有 CSRF 保护 (CWE-352)

**问题**: 未找到 CSRF 令牌实现

**影响**: 跨站请求伪造攻击 - 代表经过身份验证的用户执行未授权操作

**建议**: 实现 CSRF 令牌（双重提交 Cookie 模式或同步令牌模式）

---

### 7. 未找到 CORS 配置 (CWE-942)

**问题**: 未检测到 CORS 中间件/配置文件

**影响**: 如果配置不当，可能导致跨域攻击

**建议**: 在后端配置严格的 CORS 源:
```typescript
// 示例: 仅允许您的域名
cors({
  origin: ['https://monera-digital.vercel.app'],
  credentials: true
})
```

---

### 8. 使用 `dangerouslySetInnerHTML` (CWE-79)

**文件**: `src/components/ui/chart.tsx:70`

```typescript
<ChartStyle id={chartId} config={config} />
  dangerouslySetInnerHTML={{ __html: cssRule }}
```

**风险**: 如果 `config` 变为用户可控，可能导致 XSS

**建议**: 在渲染前用 Zod 验证 `config`

---

### 9. 错误处理不一致

**受影响文件**: 多个 API 调用

**问题**: 三种不同的错误处理模式:
```typescript
// 模式 1: 基本检查
if (!res.ok) throw new Error("Failed");

// 模式 2: Toast 通知
toast.error(data.error || "Error");

// 模式 3: 静默错误
.catch((err) => console.error(err));
```

**风险**:
- 用户体验不一致
- 某些错误静默失败
- 难以追踪错误模式

**建议**: 使用错误边界 + 一致的 toast 通知集中错误处理

---

### 10. 没有自动令牌注入的认证拦截器

**问题**: 每个 API 调用都手动添加 `Authorization` 头:
```typescript
const token = localStorage.getItem("token");
headers: { Authorization: `Bearer ${token}` }
```

**风险**:
- 样板代码分散在 10+ 个文件中
- 容易在新端点上忘记令牌
- 没有集中的认证失败处理

**建议**: 创建 API 拦截器:
```typescript
const api = axios.create({ baseURL: getApiUrl() });
api.interceptors.request.use(config => {
  config.headers.Authorization = `Bearer ${localStorage.getItem("token")}`;
  return config;
});
```

---

### 11. 过时的安全关键包

| 包 | 当前版本 | 最新版本 | 问题 |
|---------|---------|--------|-------|
| `bcryptjs` | 2.4.3 | 3.0.3 | 主要安全改进 |
| `otplib` | 12.0.1 | 13.1.1 | 2FA 实现 |
| `zod` | 3.25.76 | 4.3.6 | 输入验证 |

**建议**: 审查并升级（bcryptjs v3 有破坏性更改）

---

## 🟡 中等优先级问题

### 12. 文本字段没有输入修剪

**问题**: 用户输入未修剪，允许仅空格值

**建议**: 对所有字符串输入添加 `.trim()`

---

### 13. React Router 开放重定向漏洞

**依赖**: `@remix-run/router` - GHSA-2w69-qvjg-hvjx

**状态**: 已在依赖审计中标记

**建议**: 更新到最新版本，验证重定向 URL（已有 `validateRedirectPath()` - 确保到处都使用）

---

### 14. 没有 DOMPurify 用于用户内容清理

**问题**: 仅依赖 React 的默认转义

**风险**: 如果直接渲染用户内容，存在 XSS 漏洞

**建议**: 安装并对任何用户控制的内容使用 DOMPurify

---

### 15. 没有路由级守卫

**问题**: 仅通过 `DashboardLayout` 进行组件级保护

**风险**: 竞态条件，用户在重定向前短暂看到受保护的内容

**建议**: 使用 React Router v6 loader 函数进行服务端路由保护

---

### 16. 没有内容安全策略 (CSP)

**问题**: 未配置 CSP 头

**风险**: XSS 攻击、数据泄露

**建议**: 实现严格的 CSP 头:
```http
Content-Security-Policy: default-src 'self'; script-src 'self'; connect-src 'self' https://*.vercel.app; object-src 'none';
```

---

### 17. 前端没有速率限制检测

**问题**: 没有处理 429（请求过多）响应

**风险**: 速率限制时用户体验差

**建议**: 实现指数退避和对速率限制请求的用户反馈

---

### 18. 混合的 API 客户端方法

**问题**: 某些文件使用集中的 `apiRequest()`，其他使用原始 `fetch()`

**文件**:
- 使用 `apiRequest()`: `api-client.ts`
- 使用 `fetch()`: Login.tsx, Register.tsx, 大多数仪表板页面

**建议**: 统一使用 `apiRequest()` 或创建统一的 API 客户端

---

## 🟢 低优先级问题

### 19. 外部 API 集成 (Safeheron) 使用模拟模式

**文件**: `src/lib/safeheron-service.ts`

**状态**: 有开发环境的后备模拟模式

**建议**: 确保模拟模式在生产环境中永不运行

---

### 20. API 响应没有安全头

**问题**: 没有 `X-Content-Type-Options`, `X-Frame-Options` 等

**建议**: 在后端配置安全中间件

---

## ✅ 发现的积极安全实践

1. **没有硬编码机密** - 环境变量正确隔离到后端
2. **没有第三方分析/跟踪** - 干净的 `index.html`
3. **生产代码中没有外部 CDN 脚本**
4. **后端使用 Zod 验证**（前端不一致）
5. **2FA 已实现** - 包含备份代码
6. **重定向路径验证** - `validateRedirectPath()` 防止开放重定向
7. **Safeheron API 集成使用 HMAC-SHA256 签名**
8. **TypeScript 严格模式** - 类型安全防止某些漏洞

---

## 📋 修复优先级矩阵

| 问题 | 优先级 | 工作量 | 影响 | 建议 |
|-------|--------|--------|------|------|
| JWT 存储在 localStorage 中 | P0 | 高 | 严重 | 迁移到 httpOnly cookies |
| 依赖漏洞 | P0 | 低 | 严重 | 运行 `npm audit fix` |
| 没有输入验证（表单） | P0 | 中 | 高 | 添加 Zod 架构 |
| 敏感控制台日志 | P0 | 低 | 高 | 移除所有 console.* 语句 |
| 没有令牌刷新 | P1 | 高 | 中 | 实现刷新流程 |
| 没有 CSRF 保护 | P1 | 中 | 高 | 添加 CSRF 令牌 |
| 没有 CORS 配置 | P1 | 低 | 中 | 配置 CORS 中间件 |
| `dangerouslySetInnerHTML` | P2 | 低 | 中 | 用 Zod 验证 |
| 错误处理不一致 | P2 | 中 | 中 | 集中错误处理 |
| 没有认证拦截器 | P2 | 低 | 中 | 创建 API 拦截器 |

---

## 🎯 建议行动计划

### 立即（本周内）
1. 运行 `npm audit fix` 解决依赖漏洞
2. 从生产代码中移除所有 console.log/console.error 语句
3. 为 Addresses.tsx 和 Lending.tsx 添加客户端 Zod 验证

### 短期（未来 2 周）
4. 设计并实现基于 httpOnly cookie 的认证
5. 添加令牌刷新机制
6. 实现 CSRF 保护
7. 配置严格的 CORS 源

### 中期（下个月）
8. 创建带有认证拦截器的集中 API 客户端
9. 实现内容安全策略
10. 添加速率限制检测和用户反馈
11. 使用 React Router loaders 添加路由级守卫

### 长期
12. 迁移到 bcryptjs v3.0.3
13. 实现全面的安全头
14. 添加安全单元测试
15. 设置自动安全扫描（npm audit, Snyk 等）

---

## 📊 风险评估摘要

**修复前**: 高风险
- 5 个严重漏洞
- 6 个高优先级问题
- JWT 令牌暴露于 XSS 攻击
- 15 个已知依赖漏洞

**修复后**: 低风险
- 所有严重漏洞已解决
- httpOnly cookies 防止 XSS 令牌窃取
- 适当的验证防止注入攻击
- 自动安全监控

---

## 🔍 测试建议

1. **安全测试**: 将 OWASP ZAP 或 Burp Suite 添加到 CI/CD
2. **单元测试**: 为安全关键函数添加测试（验证、认证）
3. **E2E 测试**: 添加安全焦点 E2E 测试（XSS 尝试、CSRF 尝试）
4. **依赖扫描**: 集成 Snyk 或 Dependabot

---

**报告生成者**: Sisyphus AI Agent
**下次审查**: 实施 P0 和 P1 修复后
