# Bug Fix Proposal: 2FA QR Code Display Issue

## Problem Statement

When users click "Enable 2FA" in the Security page, the QR code fails to display and the browser console shows the error:
```
GET otpauth://totp/Monera%20Digital:gyc567@gmail.com?algorithm=SHA1&digits=6&issuer=Monera%20Digital&period=30&secret=2KROGCICQMAGIEIS4EXBATT2F5GCNAKC net::ERR_UNKNOWN_URL_SCHEME
```

## Root Cause Analysis

1. **Backend Response**: The Go backend (`internal/services/twofa_service.go:103-105`) returns both `qrCodeUrl` and `otpauth` fields, both containing the `otpauth://` URI string.

2. **Frontend Logic Error**: In `src/pages/dashboard/Security.tsx:84`, the frontend incorrectly assigns the `qrCodeUrl` (which is an `otpauth://` URI) directly to the `qrCode` state variable, instead of generating a QR code image from it.

3. **React useEffect Logic**: The `useEffect` at line 30-45 is designed to convert `otpauth` to a QR code image, but the frontend code at line 84 overwrites the `qrCode` state with the raw `otpauth://` URI before the useEffect can process it.

4. **Result**: The browser attempts to load `otpauth://totp/...` as an image source, which fails with `ERR_UNKNOWN_URL_SCHEME`.

## Solution Design (KISS Principle)

### Option 1: Backend Returns QR Code Image (Recommended)
**Pros**: 
- Single source of truth - backend generates QR code
- Frontend becomes simpler (remove QRCode library dependency)
- Better separation of concerns

**Cons**:
- Backend needs QR code generation library
- Slightly larger response payload (base64 image)

### Option 2: Frontend Only Uses `otpauth` Field (Simpler)
**Pros**:
- Minimal code change
- No backend changes required
- Frontend already has QRCode library

**Cons**:
- Frontend still has QR generation responsibility

### **Selected Solution: Option 2 (Frontend Fix)**
We choose Option 2 because:
1. QRCode library is already installed and working
2. Zero backend changes = lower risk
3. Follows existing architecture pattern
4. Faster to implement and test

## Implementation Plan

### 1. Frontend Changes

**File**: `src/pages/dashboard/Security.tsx`

**Change 1**: Fix the state assignment in `handleSetup` (line 84)
```typescript
// BEFORE (line 82-87):
const payload = data.data || data;
setQrCode(payload.qrCodeUrl);  // ❌ Wrong: assigns otpauth:// URI
setOtpauth(payload.otpauth);
setSecret(payload.secret);

// AFTER:
const payload = data.data || data;
setOtpauth(payload.otpauth);   // ✅ Correct: only set otpauth
setSecret(payload.secret);
// Note: qrCode will be generated by useEffect
```

**Change 2**: Remove redundant `qrCodeUrl` field usage
```typescript
// Keep the existing useEffect (lines 30-45) - it's correct
useEffect(() => {
  if (otpauth) {
    QRCode.toDataURL(otpauth, {
      margin: 2,
      width: 400,
      color: {
        dark: "#000000",
        light: "#ffffff"
      }
    })
      .then(url => setQrCode(url))
      .catch(err => {
        console.error("Failed to generate QR code:", err);
      });
  }
}, [otpauth]);
```

### 2. Backend Changes

**File**: `internal/services/twofa_service.go`

**Optional Cleanup**: Make field names consistent
```go
// Line 101-106: Keep both fields for backward compatibility
return &SetupResponse{
    Secret:      secret.Secret(),
    QRCode:      secret.URL(),      // Keep for backward compatibility
    BackupCodes: backupCodes,
    OTPAuth:     secret.URL(),      // Frontend should use this
}, nil
```

**Note**: We keep `QRCode` field for backward compatibility but document that `OTPAuth` is the preferred field.

### 3. Testing Strategy

#### Unit Tests

**File**: `src/pages/dashboard/Security.test.tsx` (new file)
```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import Security from './Security';

describe('Security - 2FA QR Code Display', () => {
  it('should generate QR code from otpauth URI', async () => {
    // Mock fetch response
    global.fetch = vi.fn().mockResolvedValue({
      ok: true,
      json: async () => ({
        data: {
          secret: 'TEST_SECRET',
          otpauth: 'otpauth://totp/Monera%20Digital:test@example.com?secret=TEST_SECRET',
          backupCodes: ['code1', 'code2']
        }
      })
    });

    render(<Security />);
    
    // Click enable button
    const enableBtn = screen.getByText(/enable2FA/i);
    await userEvent.click(enableBtn);

    // Wait for QR code to be generated
    await waitFor(() => {
      const img = screen.getByAlt('2FA QR Code');
      expect(img).toBeInTheDocument();
      expect(img.getAttribute('src')).toMatch(/^data:image\/png;base64,/);
    });
  });

  it('should not use qrCodeUrl directly as image source', async () => {
    global.fetch = vi.fn().mockResolvedValue({
      ok: true,
      json: async () => ({
        data: {
          secret: 'TEST_SECRET',
          qrCodeUrl: 'otpauth://totp/test',
          otpauth: 'otpauth://totp/test',
          backupCodes: []
        }
      })
    });

    render(<Security />);
    
    const enableBtn = screen.getByText(/enable2FA/i);
    await userEvent.click(enableBtn);

    await waitFor(() => {
      const img = screen.getByAlt('2FA QR Code');
      // Should be base64, not otpauth://
      expect(img.getAttribute('src')).not.toMatch(/^otpauth:/);
    });
  });
});
```

#### Integration Tests

**File**: `tests/2fa-qrcode-display.spec.ts` (new file)
```typescript
import { test, expect } from '@playwright/test';

test.describe('2FA QR Code Display', () => {
  test('should display QR code when enabling 2FA', async ({ page }) => {
    // Login
    await page.goto('/login');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'password123');
    await page.click('button[type="submit"]');

    // Navigate to security page
    await page.goto('/dashboard/security');

    // Click enable 2FA
    await page.click('text=Enable 2FA');

    // Wait for dialog to open
    await page.waitForSelector('[role="dialog"]');

    // Check QR code image loads correctly
    const qrImage = page.locator('img[alt="2FA QR Code"]');
    await expect(qrImage).toBeVisible();
    
    // Verify it's a data URL, not otpauth://
    const src = await qrImage.getAttribute('src');
    expect(src).toMatch(/^data:image\/png;base64,/);
    expect(src).not.toMatch(/^otpauth:/);

    // Verify no console errors
    const errors: string[] = [];
    page.on('console', msg => {
      if (msg.type() === 'error') {
        errors.push(msg.text());
      }
    });
    
    expect(errors).toHaveLength(0);
  });
});
```

### 4. Regression Testing

**Checklist**:
- [ ] 2FA setup flow completes successfully
- [ ] QR code displays as image (not otpauth:// URI)
- [ ] Secret key copy button works
- [ ] "Open in App" link works
- [ ] Backup codes display correctly
- [ ] 2FA enable/disable flow works
- [ ] No console errors during 2FA setup
- [ ] Other security features (password change, whitelist) unaffected

## Risk Assessment

**Risk Level**: Low

**Isolation**: 
- Changes are confined to Security.tsx component
- No API contract changes
- No database schema changes
- No impact on other features

**Rollback Plan**: 
- Simple git revert of the single file change
- No data migration needed

## Definition of Done

- [ ] Code changes implemented
- [ ] Unit tests written and passing (100% coverage for changed code)
- [ ] Integration tests written and passing
- [ ] Manual testing completed on dev environment
- [ ] QR code displays correctly in browser
- [ ] No console errors related to ERR_UNKNOWN_URL_SCHEME
- [ ] All regression tests pass
- [ ] Code review completed
- [ ] Documentation updated (if needed)

## Test Coverage Target

**Target**: 100% coverage for changed code

**Files to Cover**:
1. `src/pages/dashboard/Security.tsx` - 2FA setup handler and QR code generation logic
2. Integration test for full 2FA flow

## Implementation Timeline

**Estimated Effort**: 2 hours
- Implementation: 30 minutes
- Unit tests: 30 minutes  
- Integration tests: 30 minutes
- Manual testing: 30 minutes

## References

- Error: `ERR_UNKNOWN_URL_SCHEME` for `otpauth://` URI
- File: `src/pages/dashboard/Security.tsx:84`
- Backend: `internal/services/twofa_service.go:103-105`
- QRCode library: https://github.com/soldair/node-qrcode
